<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>NOTION API HUB â€” í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
    :root{
      --gap:12px;
      --radius:10px;
      --border:#e5e7eb;
      --muted:#6b7280;
      /* ğŸ’š ë©”ì¸ í¬ì¸íŠ¸ ìƒ‰ìƒ: ì§„í•œ ë…¹ìƒ‰ */
      --main-color: #14532D; 
      /* ğŸŸ¢ í…Œì´ë¸” í•˜ì´ë¼ì´íŠ¸ ìƒ‰ìƒ: ë°ì€ ë…¹ìƒ‰ */
      --table-header: #D1FAE5;
      --table-text: #14532D;
      
      /* ğŸ› ï¸ ê¸°ë³¸ ì¹´ë“œ ë„ˆë¹„ (ì„ íƒ ì •ë³´) */
      --base-max-width: 700px;

      /* ğŸ“Œ ì§€ë„ í•€ ìƒ‰ìƒ (ê¸°ì¡´ ìœ ì§€) */
      --pin-reg:   #2563eb; 
      --pin-search:#ef4444;
    }
    
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Segoe UI Emoji,Segoe UI Symbol,sans-serif;
      margin: 0; 
      padding: 24px 0;
      background: #fafafa;
      color: #111;
      display: flex; 
      flex-direction: column;
      align-items: center; 
    }
    
    h1{font-size:20px;margin:0 0 16px; padding: 0 16px; width: min(100%, var(--base-max-width));} 
    h3{ color: var(--main-color); margin-top:18px; font-weight:700; } 

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px; 
      margin-bottom:16px;
      width: min(100% - 32px, var(--base-max-width)); 
      box-sizing: border-box; 
    }
    
    .card.expanded {
        width: min(100% - 32px, calc(var(--base-max-width) * 1.5));
    }
    
    /* ğŸ› ï¸ í•­ëª©ëª…(1fr)ê³¼ ì…ë ¥ì¹¸(3fr) ë„ˆë¹„ ìœ ì§€ */
    .row{display:grid;grid-template-columns:1fr 3fr;gap:var(--gap);align-items:center;margin-bottom:10px}
    /* ğŸ› ï¸ region-map-rowëŠ” ì§€ë„ì—´ê¸° ë²„íŠ¼ì„ ì•ˆì— ë„£ìœ¼ë¯€ë¡œ, ì¼ë°˜ rowì™€ ë™ì¼í•˜ê²Œ 1fr 3fr êµ¬ì¡°ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤. */
    .row.region-map-row { grid-template-columns: 1fr 3fr; } 
    .row:last-child { margin-bottom: 0; }
    
    /* ğŸ› ï¸ ë“œë¡­ë‹¤ìš´ ëª©ë¡ì´ ë¶€ëª¨ ìš”ì†Œ(.combo) ë„ˆë¹„ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì • */
    .combo{position:relative}
    /* ğŸ› ï¸ ì½¤ë³´ë°•ìŠ¤ ì…ë ¥ í•„ë“œì˜ ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ëŠ˜ë ¤ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
    .combo input{width:100%;padding:10px 12px 10px 12px;border:1px solid var(--border);border-radius:8px;outline:none}
    
    /* ğŸ› ï¸ ì§€ì—­ ì½¤ë³´ë°•ìŠ¤ì—ë§Œ ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ë²„íŠ¼ í¬ê¸°ë§Œí¼ ì¶”ê°€í•©ë‹ˆë‹¤. */
    #regionCombo input {
        padding-right: calc( (var(--gap) * 0.7) + 30px); /* íŒ¨ë”©: 30px, ë²„íŠ¼ ë„ˆë¹„: ì•½ 70px, ì´ 100px. */
    }

    .combo .list{
      position:absolute;
      z-index:10;
      left:0;
      max-width: 100%;
      max-height:220px;
      overflow:auto;
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      margin-top:6px;
      display:none;
    }
    .combo.open .list{display:block}
    
    .item{padding:8px 10px;cursor:pointer}
    .item:hover{background:#f3f4f6}
    .tag{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:4px 8px;margin-right:6px;margin-top:6px}
    .muted{color:var(--muted)}

    /* ğŸ› ï¸ 'ì§€ë„ ì—´ê¸°' ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ì œê±° (ë” ì´ìƒ ë³„ë„ì˜ ê·¸ë¦¬ë“œ ì…€ì´ ì•„ë‹˜) */
    /* .row.region-map-row > div:last-child { ... } ì œê±° */

    /* ğŸ’š ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì •: ì§„í•œ ë…¹ìƒ‰ ì ìš© */
    button{
      border-radius:8px;
      border:1px solid var(--main-color);
      background:var(--main-color);
      color:#fff;
      cursor:pointer; 
      transition: background-color 0.15s, border-color 0.15s;
      width: fit-content; 
      white-space: nowrap; 
    }
    button:hover:not(:disabled){ background: #228b22; border-color: #228b22; }
    button:disabled{opacity:.6;cursor:not-allowed}
    
    /* ğŸ› ï¸ ì§€ë„ ì—´ê¸° ë²„íŠ¼ íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼ (ì§€ì—­ ì½¤ë³´ë°•ìŠ¤ ì•ˆì— ìœ„ì¹˜) */
    #btnToggleMap {
        position: absolute;
        /* ğŸ› ï¸ ë„ˆë¹„ 70% ì¶•ì†Œ: ì•½ 70pxë¡œ ì„¤ì • */
        width: 70px; 
        right: 4px; /* ì˜¤ë¥¸ìª½ì—ì„œ ì‚´ì§ ë„ìš°ê¸° */
        top: 50%;
        transform: translateY(-50%);
        padding: 6px 4px; /* ë²„íŠ¼ íŒ¨ë”© ì¡°ì • */
        font-size: 13px; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
        z-index: 15; /* ë“œë¡­ë‹¤ìš´ ëª©ë¡ ìœ„, ì…ë ¥í•„ë“œ ìœ„ì— ë³´ì´ë„ë¡ z-index ì„¤ì • */
    }

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left; vertical-align: top;}
    th{background:var(--table-header); color:var(--table-text); font-weight:700;}
    table thead th:first-child,
    table tbody td:first-child { width: 30%; font-weight: 700; } 
    table tbody td:first-child { background: var(--table-header); } 
    
    .hint{font-size:12px;color:var(--muted)}
    .row .stack{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .pill.active{background:var(--main-color);color:#fff;border-color:var(--main-color)}
    
    /* ğŸ› ï¸ CBM ì…ë ¥ ì¹¸ ë””ìì¸ í†µì¼ (ë„ˆë¹„ëŠ” ì½¤ë³´ë°•ìŠ¤ì™€ ë™ì¼í•˜ê²Œ 100%ë¥¼ ë”°ë¦„) */
    #cbmInput {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      box-sizing: border-box; 
    }

      /* ì»¤ìŠ¤í…€ í•€ ê³µí†µ ìŠ¤íƒ€ì¼ ìœ ì§€ */
      .pin-wrap{
        position:relative; width:26px; height:26px;
        filter:drop-shadow(0 1px 1px rgba(0,0,0,.35));
      }
      .pin-svg{ display:block; width:100%; height:100%; }
      .pin-label{ position:absolute; left:50%; top:-6px; transform:translateX(-50%); background:rgba(255,255,255,.85); border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; font-size:11px; white-space:nowrap; }
  </style>

  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>
  <h1>NOTION API HUB â€” í…ŒìŠ¤íŠ¸</h1>

  <div class="card">
    <div class="row">
      <label>ì™¸êµìœ ë¬´ (ë‹¤ì¤‘ì„ íƒ)</label>
      <div class="stack" id="rolesBox">
        <span class="pill" data-role="DIPLOMAT">DIPLOMAT</span>
        <span class="pill" data-role="NON-DIPLOMAT">NON-DIPLOMAT</span>
      </div>
    </div>

    <div class="row">
      <label>êµ­ê°€</label>
      <div class="combo" id="countryCombo">
        <input type="text" placeholder="êµ­ê°€ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: ë¯¸êµ­, ì¤‘êµ­)" autocomplete="off">
        <div class="list"></div>
      </div>
    </div>

    <div class="row region-map-row">
      <label>ì§€ì—­</label>
      <div class="combo" id="regionCombo">
        <input type="text" placeholder="ì§€ì—­ì„ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì§€ì—­, Bì§€ì—­)" autocomplete="off" disabled>
        <div class="list"></div>
        <button id="btnToggleMap" type="button">ì§€ë„ ì—´ê¸°</button> 
      </div>
      </div>
    
    <div id="mapWrap" style="display:none; margin:8px 0;">
      <div id="map" style="height:360px;border-radius:12px;"></div>
      <div class="muted" style="margin-top:6px">
        â€¢ í•€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì§€ì—­ì´ ìë™ ì„ íƒë©ë‹ˆë‹¤. â€¢ ìƒë‹¨ ë‹ë³´ê¸°ì—ì„œ ìœ„ì¹˜ ê²€ìƒ‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.  
        â€¢ ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ì§€ì—­ì„ ì…ë ¥í•œ ê²½ìš°, ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ìœ¼ë¡œ ìë™ ë³´ì •ë©ë‹ˆë‹¤.
      </div>
    </div>

    <div class="row">
      <label>ì—…ì²´</label>
      <div class="combo" id="companyCombo">
        <input type="text" placeholder="ì—…ì²´ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì—…ì²´, Bì—…ì²´)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <label>ì»¨í…Œì´ë„ˆ/ì½˜ì†”</label>
      <div class="combo" id="typeCombo">
        <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" value="20FT">
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <label>CBM</label>
      <input id="cbmInput" type="number" min="0" step="1" placeholder="ì˜ˆ: 10 (ë¯¸ì…ë ¥ ì‹œ MIN CBM ê¸°ì¤€)"/>
    </div>

    <div class="row">
      <div></div>
      <div><button id="btnFetch">ì¡°íšŒ</button></div>
    </div>
  </div>

  <div class="card"> <div class="muted">ì‘ë‹µ</div> <pre id="jsonOut" class="muted" style="white-space:pre-wrap;word-break:break-word;"></pre> </div>

  <div class="card expanded">
    <div class="muted">í‘œ (item ê¸°ì¤€, ë…¸ì…˜ ìˆœì„œ ìœ ì§€)</div>
    <div id="tableWrap" class="muted">ì¡°íšŒ í›„ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤.</div>
  </div>
  
<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì„¤ì •
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê°™ì€ ë„ë©”ì¸ì—ì„œ ì“°ë©´ '' ì‚¬ìš©. ë‹¤ë¥¸ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸ë©´ ì ˆëŒ€ URL ì‚¬ìš©.
  const BASE = 'https://notion-api-hub.vercel.app';
  // MAP.JSONì€ ì´ HTMLê³¼ ê°™ì€ í´ë”ì— ë‘ì„¸ìš”.
  // í˜•ì‹:
  // {
  //   "ë¯¸êµ­": [
  //     { "name": "Aì§€ì—­", "lat": 37.5, "lng": -122.0 },
  //     { "name": "Bì§€ì—­", "lat": 34.0, "lng": -118.2 }
  //   ],
  //   "ë¸Œë¼ì§ˆ": [
  //     { "name": "Brasilia, Brazil", "lat": -15.8267, "lng": -47.9218 }
  //   ]
  // }
  // nameì€ ë…¸ì…˜ "ì§€ì—­"ê³¼ ë™ì¼í•œ í…ìŠ¤íŠ¸ ê¶Œì¥.

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê³µí†µ UI: ë‹¤ì¤‘ì„ íƒ(ì™¸êµìœ ë¬´) / ì½¤ë³´(ì…ë ¥+í•„í„°+ì„ íƒ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rolesBox = document.getElementById('rolesBox');
  rolesBox.addEventListener('click', (e) => {
    const pill = e.target.closest('.pill');
    if (!pill) return;
    pill.classList.toggle('active');
  });

  function makeCombo(el, items = []) {
    const input = el.querySelector('input');
    const list  = el.querySelector('.list');
    let data = [...items];
    let selected = null;

    function render(filter='') {
      const f = filter.trim().toLowerCase();
      list.innerHTML = '';
      const filtered = data.filter(x => x.toLowerCase().includes(f));
      // ìˆ«ì ìì—° ì •ë ¬ + ì ‘ë‘ì–´ ìš°ì„ 
      const sorted = filtered.sort((a, b) => {
        const an = Number(a), bn = Number(b);
        if (!isNaN(an) && !isNaN(bn)) return an - bn;
        const ap = a.toLowerCase().startsWith(f) ? 0 : 1;
        const bp = b.toLowerCase().startsWith(f) ? 0 : 1;
        if (ap !== bp) return ap - bp;
        return a.localeCompare(b, 'ko');
      });
      sorted.forEach(v => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = v;
        div.onclick = () => {
          selected = v;
          input.value = v;
          el.classList.remove('open');
          list.innerHTML = '';
          el.dispatchEvent(new CustomEvent('change', { detail: v }));
        };
        list.appendChild(div);
      });
    }

    function setItems(arr) {
      data = [...new Set(arr.filter(Boolean))];
      input.disabled = data.length === 0;
      input.value = '';
      selected = null;
      render('');
    }

    function getValue() {
      return selected || input.value.trim();
    }

    // ì¶”ê°€: í˜„ì¬ ëª©ë¡/ê°’ ì„¸í„° (ì§€ë„/ìë™ë³´ì •ì—ì„œ ì‚¬ìš©)
    function getItems() { return [...data]; }
    function setValue(v) {
      selected = v;
      input.value = v;
      el.dispatchEvent(new CustomEvent('change', { detail: v }));
    }

    input.addEventListener('focus', () => { el.classList.add('open'); render(input.value); });
    input.addEventListener('input', () => { el.classList.add('open'); render(input.value); });
    document.addEventListener('click', (e) => { if (!el.contains(e.target)) el.classList.remove('open'); });

    setItems(items);
    return { setItems, getItems, getValue, setValue, input, list, root: el };
  }

  const countryCombo = makeCombo(document.getElementById('countryCombo'));
  const regionCombo  = makeCombo(document.getElementById('regionCombo'));
  const companyCombo = makeCombo(document.getElementById('companyCombo'));
  const typeCombo    = makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);

  // â”€â”€ ì»¤ìŠ¤í…€ í•€ ì•„ì´ì½˜(SVG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // color: ì±„ì›€ìƒ‰, withLabel: ë¼ë²¨ í‘œì‹œ ì—¬ë¶€, labelText: ë¼ë²¨ ë‚´ìš©
  function makeSvgPinIcon(color, withLabel=false, labelText="") {
    const svg = `
    <svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5
        a2.5 2.5 0 0 1 0 5z"/>
    </svg>`;
    const labelHtml = withLabel
      ? `<div class="pin-label">${escapeHtml(labelText)}</div>`
      : "";
    const html = `<div class="pin-wrap">${svg}${labelHtml}</div>`;
    return L.divIcon({
      className: "",
      html,
      iconSize: [26, 26],
      iconAnchor: [13, 26] // ì•„ë˜ ì¤‘ì•™ì´ ì¢Œí‘œë¥¼ ì •í™•íˆ ê°€ë¦¬í‚¤ë„ë¡
    });
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì§€ë„ ìƒíƒœ/ìœ í‹¸ (Leaflet + Geocoder + MAP.JSON)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let map, markerLayer, geocoder, mapInited = false;
  let mapData = null;           // ì „ì²´ MAP.JSON
  let countryMarkers = [];      // í˜„ì¬ êµ­ê°€ ë§ˆì»¤ [{name,lat,lng,marker}]
  let __stickyNotice = null;    // ìƒë‹¨ ê³ ì • ì•Œë¦¼(ë°°ë„ˆ) + ì¼íšŒì„± í† ìŠ¤íŠ¸ ë‘˜ ë‹¤ ì§€ì›

  function toast(msg, opts = {}) {
    const { sticky = false, timeout = 1500 } = opts;
  
    // sticky ëª¨ë“œ: í´ë¦­ ì „ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìƒë‹¨ ë°°ë„ˆ
    if (sticky) {
      if (__stickyNotice) __stickyNotice.remove(); // ê¸°ì¡´ ë°°ë„ˆ ìˆìœ¼ë©´ êµì²´
      const el = document.createElement('div');
      el.innerHTML = `
        <div style="
          position: fixed; left: 50%; top: 16px; transform: translateX(-50%);
          background: rgba(17,17,17,.92); color: #fff; padding: 10px 14px;
          border-radius: 10px; border: 1px solid rgba(255,255,255,.15);
          box-shadow: 0 2px 8px rgba(0,0,0,.35);
          z-index: 10000; font-size: 13px; display:flex; align-items:center; gap:10px;
        ">
          <span>${msg}</span>
          <button id="__stickyClose" type="button" style="
            background:#fff; color:#111; border:0; border-radius:8px; padding:6px 10px; cursor:pointer;
          ">ë‹«ê¸°</button>
        </div>
      `;
      el.querySelector('#__stickyClose').addEventListener('click', () => {
        el.remove(); __stickyNotice = null;
      });
      // ë°°ë„ˆ ìì²´ í´ë¦­ìœ¼ë¡œ ë‹«íˆê²Œ í•˜ë ¤ë©´ ë‹¤ìŒ ì¤„ ì£¼ì„ í•´ì œ
      // el.firstElementChild.addEventListener('click', () => { el.remove(); __stickyNotice = null; });
  
      document.body.appendChild(el);
      __stickyNotice = el;
      return;
    }
  
    // ê¸°ë³¸(ì¼íšŒì„±) í† ìŠ¤íŠ¸
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.cssText = `
      position: fixed; left: 50%; top: 24px; transform: translateX(-50%);
      background: rgba(0,0,0,.75); color: #fff; padding: 8px 12px; border-radius: 8px;
      z-index: 10000; font-size: 13px;
    `;
    document.body.appendChild(d);
    setTimeout(()=> d.remove(), timeout);
  }
  
  // í•„ìš” ì‹œ ì™¸ë¶€ì—ì„œ ê°•ì œë¡œ ë‹«ëŠ” í•¨ìˆ˜
  function hideStickyToast(){
    if (__stickyNotice) { __stickyNotice.remove(); __stickyNotice = null; }
  }

  // Haversine ê±°ë¦¬(km)
  function haversineKm(aLat, aLng, bLat, bLng) {
    const R = 6371;
    const dLat = (bLat - aLat) * Math.PI/180;
    const dLng = (bLng - aLng) * Math.PI/180;
    const A = Math.sin(dLat/2)**2 +
              Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*
              Math.sin(dLng/2)**2;
    return 2 * R * Math.asin(Math.sqrt(A));
  }

  function findNearest(lat, lng, points) {
    if (!points || !points.length) return null;
    let best = null, bestD = Infinity;
    for (const p of points) {
      const d = haversineKm(lat, lng, p.lat, p.lng);
      if (d < bestD) { best = p; bestD = d; }
    }
    return { point: best, distanceKm: bestD };
  }

async function ensureMapReady() {
  if (mapInited) return;
  mapInited = true;

  // ğŸ”’ ì„¸ê³„ í•œ ì¥ë§Œ ë³´ì´ë„ë¡ ê²½ê³„ ì§€ì • (ê²½ë„ Â±180, ìœ„ë„ëŠ” Web Mercator ìœ íš¨ ë²”ìœ„)
  const worldBounds = L.latLngBounds([[-85, -180], [85, 180]]);

  map = L.map('map', {
    center: [20, 0],
    zoom: 2,
    // ğŸ”‘ ì¢Œìš° ë³µì œ ì›”ë“œ(ë˜í•‘) ë°©ì§€ + ê²½ê³„ ë°–ìœ¼ë¡œ ë“œë˜ê·¸ ëª» í•˜ê²Œ
    worldCopyJump: false,
    maxBounds: worldBounds,
    maxBoundsViscosity: 1.0    // 0~1 (1ì´ë©´ ê²½ê³„ì— ì°°ì‹¹ ë¶™ìŒ)
  });

  // ğŸ§­ íƒ€ì¼ë„ ë˜í•‘ ê¸ˆì§€ (noWrap) + ë™ì¼ ê²½ê³„ ì§€ì •
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
    noWrap: true,
    bounds: worldBounds
  }).addTo(map);

  markerLayer = L.layerGroup().addTo(map);

  // (ë‚˜ë¨¸ì§€ geocoder ì„¤ì •/ì´ë²¤íŠ¸, MAP.JSON ë¡œë”© ë“± ê¸°ì¡´ ì½”ë“œ ê³„ì†)
  geocoder = L.Control.geocoder({ defaultMarkGeocode: false })
    .on('markgeocode', (e) => {
      const c = e.geocode.center;

      // ê²€ìƒ‰ í•€: ë¼ë²¨/íŒì—… ì—†ì´ ì„ì‹œ ë§ˆì»¤
      const searchColor = getComputedStyle(document.documentElement).getPropertyValue('--pin-search').trim() || '#ef4444';
      const searchIcon  = makeSvgPinIcon(searchColor, false);
      const tmp = L.marker(c, { icon: searchIcon, keyboard:false, riseOnHover:true }).addTo(map);
      setTimeout(() => map.removeLayer(tmp), 4000);

      map.setView(c, 9);

      if (countryMarkers.length) {
        const hit = findNearest(c.lat, c.lng, countryMarkers);
        if (hit?.point) {
          regionCombo.setValue(hit.point.name);
          toast(`ê°€ì¥ ê°€ê¹Œìš´ ë“±ë¡ ì§€ì—­: ${hit.point.name} (~${hit.distanceKm.toFixed(1)}km)`, { sticky: true });
        }
      }
    })
    .addTo(map);

  // MAP.JSON ë¡œë“œ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
  try {
    const r = await fetch('./MAP.JSON', { cache: 'no-store' });
    mapData = await r.json();
  } catch (e) {
    console.warn('MAP.JSON ë¡œë“œ ì‹¤íŒ¨:', e);
    mapData = {};
  }
}


  function setMapCountry(country) {
    if (!mapInited) return;
    markerLayer.clearLayers();
    countryMarkers = [];
    if (!mapData || !mapData[country]) return;

    const pts = mapData[country];
    const bounds = [];
    pts.forEach(p => {
      // CSS ë³€ìˆ˜ì—ì„œ ë“±ë¡ í•€ ìƒ‰ì„ ì½ì–´ì˜´(ì—†ìœ¼ë©´ ê¸°ë³¸ íŒŒë‘)
      const regColor = getComputedStyle(document.documentElement).getPropertyValue('--pin-reg').trim() || '#2563eb';
      // ë¼ë²¨ì„ í‘œì‹œí•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë‘ ë²ˆì§¸ ì¸ìë¥¼ falseë¡œ ìœ ì§€
      const regIcon  = makeSvgPinIcon(regColor, false /*withLabel*/, /*labelText*/ "");
      
      // ë¼ë²¨ì„ í•€ ìœ„ì— í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ìœ„ ì¤„ ëŒ€ì‹ :
      // const regIcon  = makeSvgPinIcon(regColor, true, p.name);
      
      const m = L.marker([p.lat, p.lng], { icon: regIcon })
        .addTo(markerLayer)
        .bindPopup(p.name);

      m.on('click', () => {
        regionCombo.setValue(p.name); // í•€ í´ë¦­ â†’ ì§€ì—­ ì„¸íŒ…
        toast(`ì§€ì—­ ì„ íƒ: ${p.name}`);
      });
      countryMarkers.push({ ...p, marker: m });
      bounds.push([p.lat, p.lng]);
    });
    if (bounds.length) map.fitBounds(bounds, { padding:[20,20] });
  }

  // ì§€ë„ í† ê¸€
  document.getElementById('btnToggleMap').addEventListener('click', async () => {
    const wrap = document.getElementById('mapWrap');
    const open = wrap.style.display !== 'none';
    if (open) {
      wrap.style.display = 'none';
      document.getElementById('btnToggleMap').textContent = 'ì§€ë„ ì—´ê¸°';
    } else {
      wrap.style.display = 'block';
      await ensureMapReady();
      const c = countryCombo.getValue();
      if (c) setMapCountry(c);
      setTimeout(()=> map.invalidateSize(), 30);
      document.getElementById('btnToggleMap').textContent = 'ì§€ë„ ë‹«ê¸°';
    }
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // êµ­ê°€ â†’ ì§€ì—­ â†’ ì—…ì²´ ë¡œë”© (ë°±ì—”ë“œ API ì—°ë™)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  countryCombo.root.addEventListener('change', async () => {
    const country = countryCombo.getValue();
    if (!country) return;
    try {
      const res = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`);
      const j = await res.json();
      regionCombo.setItems(j.regions || []);
      companyCombo.setItems([]);
    } catch {
      regionCombo.setItems([]);
      companyCombo.setItems([]);
    }
    if (mapInited && document.getElementById('mapWrap').style.display !== 'none') {
      setMapCountry(country);
    }
  });

  regionCombo.root.addEventListener('change', async () => {
    const country = countryCombo.getValue();
    const region  = regionCombo.getValue();
    if (!country || !region) return;
    const mode = 'options'; // or 'data' (ëŠë¦¼)
    try {
      const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=${mode}`;
      const res = await fetch(url);
      const j = await res.json();
      companyCombo.setItems(j.companies || []);
    } catch {
      companyCombo.setItems([]);
    }
  });

  // ì´ˆê¸° êµ­ê°€ ëª©ë¡
  (async function init() {
    const dbg = await fetchDebug();
    const countries = dbg.countries || Object.keys(dbg.dbStructure || {});
    countryCombo.setItems(countries || []);
  })();

  async function fetchDebug() {
    const res = await fetch(`${BASE}/api/debug/config`);
    if (!res.ok) throw new Error('debug/config ì˜¤ë¥˜');
    return await res.json();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¡°íšŒ: ë“œë¡­ë‹¤ìš´ì— ì—†ëŠ” â€˜ììœ  ì…ë ¥ ì§€ì—­â€™ì€ ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ìœ¼ë¡œ ìë™ ë³´ì • í›„ í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btnFetch').addEventListener('click', async () => {
    const country = countryCombo.getValue();
    let   region  = regionCombo.getValue();   // ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥
    const company = companyCombo.getValue();
    const type    = typeCombo.getValue();
    const roles   = Array.from(rolesBox.querySelectorAll('.pill.active')).map(p=>p.dataset.role);
    const cbmVal  = parseInt(document.getElementById('cbmInput').value, 10);

    if (!country || !company) {
      alert('êµ­ê°€ì™€ ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }

    // (ì¤‘ìš”) ì§€ì—­ ììœ ì…ë ¥ ì‹œ ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ìœ¼ë¡œ ë³´ì •
    const list = regionCombo.getItems();
    if (region && !list.includes(region)) {
      try {
        await ensureMapReady();
        const pick = await geocodeNearest(region, country);
        if (pick) {
          toast(`ì…ë ¥í•œ ì§€ì—­ì´ ì—†ì–´ ê°€ì¥ ê°€ê¹Œìš´ ë“±ë¡ ì§€ì—­(${pick.name})ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤ (~${pick.distKm.toFixed(1)}km)`);
          region = pick.name;
          regionCombo.setValue(region);
        }
      } catch (e) {
        console.warn('ìµœê·¼ì ‘ ë³´ì • ì‹¤íŒ¨:', e);
      }
    }

    const params = new URLSearchParams();
    params.set('company', company);
    params.set('type', type);
    if (region) params.set('region', region);
    if (roles.length) params.set('roles', roles.join(','));
    if (Number.isFinite(cbmVal)) params.set('cbm', String(cbmVal)); // CONSOLE/ë³´ì • ê³„ì‚°ìš©

    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
    try {
      const res = await fetch(url);
      const j = await res.json();
      document.getElementById('jsonOut').textContent = JSON.stringify(j, null, 2);
      renderTable(j, type, Boolean(region));
    } catch (e) {
      document.getElementById('jsonOut').textContent = String(e);
      document.getElementById('tableWrap').innerHTML = '<div class="muted">ì˜¤ë¥˜ë¡œ í‘œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  });

  // Geocoderë¥¼ Promiseë¡œ ê°ì‹¸ ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ ì°¾ê¸°
  async function geocodeNearest(query, country) {
    if (!mapData || !mapData[country]?.length) return null;
    const pts = mapData[country];

    const center = await new Promise((resolve, reject) => {
      if (!geocoder || !geocoder.options?.geocoder) return resolve(null);
      geocoder.options.geocoder.geocode(query, (results) => {
        if (results && results[0]) resolve(results[0].center);
        else resolve(null);
      });
      // íƒ€ì„ì•„ì›ƒ(2.5s)
      setTimeout(()=> resolve(null), 2500);
    });

    if (!center) return null;
    const hit = findNearest(center.lat, center.lng, pts);
    if (!hit?.point) return null;
    return { name: hit.point.name, distKm: hit.distanceKm };
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // í‘œ ë Œë”ë§ (rows ìˆœì„œ ê·¸ëŒ€ë¡œ, ì¶”ê°€ë‚´ìš©ì€ HTML ê·¸ëŒ€ë¡œ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable(data, type, hasRegionFilter) {
    const wrap = document.getElementById('tableWrap');
    if (!data || data.ok === false) {
      wrap.innerHTML = '<div class="muted">ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤ë¥˜ì…ë‹ˆë‹¤.</div>';
      return;
    }
    const rows = data.rows || [];
    if (rows.length === 0) {
      wrap.innerHTML = '<div class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    if (hasRegionFilter) {
      let html = `<table><thead><tr><th>í•­ëª©</th><th>${type}</th><th>ì¶”ê°€ë‚´ìš©</th></tr></thead><tbody>`;
      for (const row of rows) {
        html += `<tr>
          <td>${escapeHtml(row.item)}</td>
          <td>${fmt(row[type])}</td>
          <td>${row.extra ?? ''}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      wrap.innerHTML = html;
    } else {
      const grouped = {};
      for (const r of rows) {
        const reg = r.region || 'ê¸°íƒ€';
        if (!grouped[reg]) grouped[reg] = [];
        grouped[reg].push(r);
      }
      let html = '';
      for (const reg of Object.keys(grouped)) {
        html += `<h3 style="margin-top:18px">${escapeHtml(reg)} (${type})</h3>`;
        html += `<table><thead><tr><th>í•­ëª©</th><th>${type}</th><th>ì¶”ê°€ë‚´ìš©</th></tr></thead><tbody>`;
        for (const row of grouped[reg]) {
          html += `<tr>
            <td>${escapeHtml(row.item)}</td>
            <td>${fmt(row[type])}</td>
            <td>${row.extra ?? ''}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
      }
      wrap.innerHTML = html;
    }
  }

  function fmt(v){ return (v===null||v===undefined) ? '' : v; }
  function escapeHtml(s){
    return String(s)
      .replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
      .replace(/\n/g,'<br>');
  }
</script>
</body>
</html>

