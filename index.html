<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>NOTION API HUB â€” í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--gap:12px;--radius:10px;--border:#e5e7eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Segoe UI Emoji,Segoe UI Symbol,sans-serif;margin:0;padding:24px;background:#fafafa;color:#111}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 2fr;gap:var(--gap);align-items:center;margin-bottom:10px}
    .combo{position:relative}
    .combo input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;outline:none}
    .combo .list{position:absolute;z-index:10;left:0;right:0;max-height:220px;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:8px;margin-top:6px;display:none}
    .combo.open .list{display:block}
    .item{padding:8px 10px;cursor:pointer}
    .item:hover{background:#f3f4f6}
    .tag{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;border:1px solid #dbeafe;border-radius:999px;padding:4px 8px;margin-right:6px;margin-top:6px}
    .muted{color:var(--muted)}
    button{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--border);padding:8px;text-align:left}
    th{background:#f9fafb}
    .hint{font-size:12px;color:var(--muted)}
    .row .stack{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .pill.active{background:#111;color:#fff;border-color:#111}
  </style>
</head>
<body>
  <h1>NOTION API HUB â€” í…ŒìŠ¤íŠ¸</h1>

  <div class="card">
    <div class="row">
      <label>ì™¸êµìœ ë¬´ (ë‹¤ì¤‘ì„ íƒ)</label>
      <div class="stack" id="rolesBox">
        <span class="pill" data-role="DIPLOMAT">DIPLOMAT</span>
        <span class="pill" data-role="NON-DIPLOMAT">NON-DIPLOMAT</span>
      </div>
    </div>

    <div class="row">
      <label>êµ­ê°€</label>
      <div class="combo" id="countryCombo">
        <input type="text" placeholder="êµ­ê°€ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: ë¯¸êµ­, ì¤‘êµ­)" autocomplete="off">
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <label>ì—…ì²´</label>
      <div class="combo" id="companyCombo">
        <input type="text" placeholder="ì—…ì²´ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì—…ì²´, Bì—…ì²´)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <label>ì§€ì—­</label>
      <div class="combo" id="regionCombo">
        <input type="text" placeholder="ì§€ì—­ì„ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì§€ì—­, Bì§€ì—­)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <label>ì†ì„±</label>
      <div class="combo" id="typeCombo">
        <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" value="20FT">
        <div class="list"></div>
      </div>
    </div>

    <div class="row">
      <div></div>
      <div>
        <button id="btnFetch">ì¡°íšŒ</button>
        <span class="hint">CONSOLEì€ ì•„ì§ ë°±ì—”ë“œ ë¯¸ì§€ì›(ì¡°íšŒ ì‹œ ì•ˆë‚´ë§Œ í‘œì‹œ)</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="muted">ì‘ë‹µ</div>
    <pre id="jsonOut" class="muted" style="white-space:pre-wrap;word-break:break-word;"></pre>
  </div>

  <div class="card">
    <div class="muted">í‘œ (item ê¸°ì¤€)</div>
    <div id="tableWrap" class="muted">ì¡°íšŒ í›„ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤.</div>
  </div>

<script>
  // ê°™ì€ ë„ë©”ì¸ì—ì„œ ì“°ë©´ '' ì‚¬ìš©. ë‹¤ë¥¸ ë„ë©”ì¸ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ì ˆëŒ€ URL ë„£ê¸°.
  const BASE = 'https://notion-api-hub.vercel.app'; // ì˜ˆ: 'https://notion-api-hub.vercel.app'

  //ë…¸ì…˜ ì¶”ê°€ì •ë³´ ì¹¸ì˜ ë³¼ë“œì²´, ë°‘ì¤„, ìƒ‰ìƒ ë“±ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„

  function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (m) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}

// ğŸ§© ë…¸ì…˜ì˜ rich_text â†’ HTML ë³€í™˜
function notionRichToHtml(richTexts = []) {
  return richTexts.map(rt => {
    let t = escapeHtml(rt.text?.content || "");
    const ann = rt.annotations || {};

    // ìŠ¤íƒ€ì¼ ë³€í™˜
    if (ann.bold) t = `<b>${t}</b>`;
    if (ann.italic) t = `<i>${t}</i>`;
    if (ann.underline) t = `<u>${t}</u>`;
    if (ann.strikethrough) t = `<s>${t}</s>`;
    if (ann.code) t = `<code>${t}</code>`;

    // ìƒ‰ìƒ (defaultëŠ” ì œì™¸)
    if (ann.color && ann.color !== "default") {
      // ë…¸ì…˜ ìƒ‰ìƒ ì´ë¦„ì€ HTML ìƒ‰ìƒëª…ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¼ë¶€ ë§¤í•‘
      const colorMap = {
        red: "#dc2626", orange: "#ea580c", yellow: "#ca8a04",
        green: "#16a34a", blue: "#2563eb", purple: "#7c3aed",
        pink: "#db2777", gray: "#6b7280"
      };
      const htmlColor = colorMap[ann.color] || ann.color;
      t = `<span style="color:${htmlColor}">${t}</span>`;
    }

    // ë§í¬
    if (rt.text?.link?.url) {
      const url = rt.text.link.url;
      t = `<a href="${url}" target="_blank" rel="noopener noreferrer">${t}</a>`;
    }

    return t;
  }).join("");
}
  
  // ê°„ë‹¨í•œ ì½¤ë³´(ì…ë ¥+í•„í„°+ì„ íƒ)
  function makeCombo(el, items = []) {
    const input = el.querySelector('input');
    const list = el.querySelector('.list');
    let data = [...items];
    let selected = null;

    function render(filter='') {
      const f = filter.trim().toLowerCase();
      list.innerHTML = '';
      const sorted = data
        .filter(x => x.toLowerCase().includes(f))
        .sort((a,b) => {
          // ì…ë ¥ì–´ë¥¼ ì ‘ë‘ë¡œ ê°–ëŠ” í•­ëª©ì„ ìš°ì„ 
          const ap = a.toLowerCase().startsWith(f) ? 0 : 1;
          const bp = b.toLowerCase().startsWith(f) ? 0 : 1;
          if (ap !== bp) return ap - bp;
          return a.localeCompare(b, 'ko');
        });
      sorted.forEach(v => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = v;
        div.onclick = () => {
          selected = v;
          input.value = v;
          el.classList.remove('open');
          list.innerHTML = '';
          el.dispatchEvent(new CustomEvent('change', { detail: v }));
        };
        list.appendChild(div);
      });
    }

    function setItems(arr) {
      data = [...new Set(arr.filter(Boolean))];
      input.disabled = data.length === 0;
      input.value = '';
      selected = null;
      render('');
    }

    function getValue() {
      return selected || input.value.trim();
    }

    input.addEventListener('focus', () => { el.classList.add('open'); render(input.value); });
    input.addEventListener('input', () => { el.classList.add('open'); render(input.value); });
    document.addEventListener('click', (e) => {
      if (!el.contains(e.target)) el.classList.remove('open');
    });

    // ì´ˆê¸° ë Œë”
    setItems(items);

    return { setItems, getValue, input, list, root: el };
  }

  const rolesBox = document.getElementById('rolesBox');
  rolesBox.addEventListener('click', (e) => {
    const pill = e.target.closest('.pill');
    if (!pill) return;
    pill.classList.toggle('active');
  });

  const countryCombo = makeCombo(document.getElementById('countryCombo'));
  const companyCombo = makeCombo(document.getElementById('companyCombo'));
  const regionCombo  = makeCombo(document.getElementById('regionCombo'));
  const typeCombo    = makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);

  // êµ­ê°€ ì„ íƒ ì‹œ â†’ ì—…ì²´ ëª©ë¡ ê°±ì‹ 
  countryCombo.root.addEventListener('change', async (ev) => {
    const country = countryCombo.getValue();
    const db = await fetchDebug();
    const companies = db.dbStructure?.[country] ? Object.keys(db.dbStructure[country]) : [];
    companyCombo.setItems(companies);
    // ì§€ì—­ì€ êµ­ê°€/ì—…ì²´ë¥¼ ì•Œì•„ì•¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë¹„ì›€
    regionCombo.setItems([]);
  });

  // ì—…ì²´ ì„ íƒ ì‹œ â†’ ì§€ì—­ ëª©ë¡ ê°±ì‹  (costs API rowsì—ì„œ region ì¶”ì¶œ)
  companyCombo.root.addEventListener('change', async (ev) => {
    const country = countryCombo.getValue();
    const company = companyCombo.getValue();
    if (!country || !company) { regionCombo.setItems([]); return; }
    // ì„ì˜ì˜ íƒ€ì…(20FT)ë¡œ rowsë§Œ ë°›ì•„ ì§€ì—­ í›„ë³´ set
    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?company=${encodeURIComponent(company)}&type=${encodeURIComponent('20FT')}`;
    try {
      const res = await fetch(url);
      const j = await res.json();
      const regions = (j.rows || []).map(r => r.region).filter(Boolean);
      regionCombo.setItems([...new Set(regions)]);
    } catch(e) {
      console.error(e);
      regionCombo.setItems([]);
    }
  });

  // ì´ˆê¸° ë¡œë”©: êµ­ê°€ ëª©ë¡ ì±„ìš°ê¸°
  (async function init() {
    const dbg = await fetchDebug();
    const countries = dbg.countries || Object.keys(dbg.dbStructure || {});
    countryCombo.setItems(countries || []);
  })();

  async function fetchDebug() {
    const res = await fetch(`${BASE}/api/debug/config`);
    if (!res.ok) throw new Error('debug/config ì˜¤ë¥˜');
    return await res.json();
  }

  // ë²„íŠ¼ í´ë¦­ â†’ ì¡°íšŒ
  document.getElementById('btnFetch').addEventListener('click', async () => {
    const country = countryCombo.getValue();
    const company = companyCombo.getValue();
    const region  = regionCombo.getValue();
    const type    = typeCombo.getValue();
    const roles   = Array.from(rolesBox.querySelectorAll('.pill.active')).map(p=>p.dataset.role);

    if (!country || !company) {
      alert('êµ­ê°€ì™€ ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    if (type === 'CONSOLE') {
      document.getElementById('jsonOut').textContent = 'CONSOLE ì†ì„±ì€ ì•„ì§ ë°±ì—”ë“œì— ì—†ì–´ì„œ ì¡°íšŒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ë‚˜ì¤‘ì— ì§€ì› ì˜ˆì •)';
      document.getElementById('tableWrap').innerHTML = '<div class="muted">ì¡°íšŒ ì—†ìŒ</div>';
      return;
    }

    const params = new URLSearchParams();
    params.set('company', company);
    params.set('type', type);
    if (region) params.set('region', region);
    if (roles.length) params.set('roles', roles.join(','));

    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
    try {
      const res = await fetch(url);
      const j = await res.json();

      document.getElementById('jsonOut').textContent = JSON.stringify(j, null, 2);
      renderTable(j, type, Boolean(region));
    } catch (e) {
      document.getElementById('jsonOut').textContent = String(e);
      document.getElementById('tableWrap').innerHTML = '<div class="muted">ì˜¤ë¥˜ë¡œ í‘œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  });

  function renderTable(data, type, hasRegionFilter) {
    const wrap = document.getElementById('tableWrap');
    if (!data || data.ok === false) {
      wrap.innerHTML = '<div class="muted">ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤ë¥˜ì…ë‹ˆë‹¤.</div>';
      return;
    }

    // region ìœ ë¬´ì— ë”°ë¼ í‰ë©´/ê·¸ë£¹ í…Œì´ë¸”
    if (hasRegionFilter) {
      // í‰ë©´: { values: {item: num}, extras: {item: text} }
      const values = data.values || {};
      const extras = data.extras || {};
      const items = Object.keys(values);

      if (items.length === 0) {
        wrap.innerHTML = '<div class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = `<table><thead><tr><th>í•­ëª©</th><th>${type}</th><th>ì¶”ê°€ë‚´ìš©</th></tr></thead><tbody>`;
      for (const it of items) {
        html += `<tr><td>${escapeHtml(it)}</td><td>${fmt(values[it])}</td><td>${escapeHtml(extras[it] ?? '')}</td></tr>`;
      }
      html += `</tbody></table>`;
      wrap.innerHTML = html;

    } else {
      // ê·¸ë£¹: { valuesByRegion: {region:{item:num}}, extrasByRegion: {region:{item:text}} }
      const vbr = data.valuesByRegion || {};
      const ebr = data.extrasByRegion || {};
      const regions = Object.keys(vbr);

      if (regions.length === 0) {
        wrap.innerHTML = '<div class="muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '';
      for (const reg of regions) {
        const vals = vbr[reg] || {};
        const exts = ebr[reg] || {};
        const items = Object.keys(vals);

        html += `<h3 style="margin-top:18px">${escapeHtml(reg)} (${type})</h3>`;
        html += `<table><thead><tr><th>í•­ëª©</th><th>${type}</th><th>ì¶”ê°€ë‚´ìš©</th></tr></thead><tbody>`;
        for (const it of items) {
          html += `<tr><td>${escapeHtml(it)}</td><td>${fmt(vals[it])}</td><td>${escapeHtml(exts[it] ?? '')}</td></tr>`;
        }
        html += `</tbody></table>`;
      }
      wrap.innerHTML = html;
    }
  }

  function fmt(v){ return (v===null||v===undefined) ? '' : v; }
  function escapeHtml(s){
  return String(s)
    .replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
    .replace(/\n/g, '<br>'); // âœ… ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
}
</script>
</body>
</html>
